# Alerting rules for the hybrid search application

groups:
- name: hybrid_search_alerts
  rules:
  # High request latency
  - alert: HighRequestLatency
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "High request latency detected"
      description: "95th percentile request latency is above 2 seconds"

  # High error rate
  - alert: HighErrorRate
    expr: rate(application_errors_total[5m]) / rate(http_requests_total[5m]) > 0.05
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected"
      description: "More than 5% of requests are failing"

  # Database connection pool exhaustion
  - alert: DatabaseConnectionPoolExhaustion
    expr: database_connection_pool_utilization{database="postgres"} > 0.9
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Database connection pool nearly exhausted"
      description: "PostgreSQL connection pool utilization is above 90%"

  # High database query latency
  - alert: HighDatabaseQueryLatency
    expr: histogram_quantile(0.95, rate(database_query_duration_seconds_bucket[5m])) > 1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High database query latency"
      description: "95th percentile database query latency is above 1 second"

  # High database error rate
  - alert: HighDatabaseErrorRate
    expr: rate(database_query_error_rate[5m]) / rate(database_query_duration_seconds_count[5m]) > 0.05
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "High database error rate"
      description: "More than 5% of database queries are failing"

  # High search latency
  - alert: HighSearchLatency
    expr: histogram_quantile(0.95, rate(search_duration_seconds_bucket[5m])) > 5
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High search latency"
      description: "95th percentile search latency is above 5 seconds"

  # Unusually high zero-results rate
  - alert: AnomalousZeroResultsRate
    expr: |
      rate(zero_results_searches_total[5m]) / rate(search_requests_total[5m])
      >
      scalar(avg_over_time((rate(zero_results_searches_total[1h]) / rate(search_requests_total[1h]))[24h:1h]))
      * 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Unusually high zero-results rate detected"
      description: "Zero-results rate is more than 2x the historical average"

  # Low search relevance
  - alert: LowSearchRelevance
    expr: histogram_quantile(0.5, rate(search_relevance_score_bucket[10m])) < 0.3
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Low search relevance detected"
      description: "Median search relevance score is below 0.3"